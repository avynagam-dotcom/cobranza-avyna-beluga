<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
  <title>Cobranza AVYNA - Beluga</title>

  <link rel="apple-touch-icon" href="/apple-touch-icon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    :root {
      --bg1: #071027;
      --bg2: #0b1535;
      --line: rgba(255, 255, 255, .10);
      --text: #e9eefc;
      --muted: rgba(233, 238, 252, .70);
      --gold: #f0c85b;
      --gold2: #e0b84b;
      --green: #57d47a;
      --red: #ff5a5a;
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 50% -100px, rgba(74, 115, 255, .25), transparent 60%),
        radial-gradient(900px 600px at 50% 110%, rgba(74, 115, 255, .18), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height: 100vh;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 48px 16px;
      padding-top: calc(48px + env(safe-area-inset-top));
      padding-bottom: calc(48px + env(safe-area-inset-bottom));
      overflow-x: hidden;
    }

    .frame {
      width: min(980px, 100%);
      border: 2px dashed rgba(255, 255, 255, .18);
      border-radius: 18px;
      padding: 28px;
      background: rgba(5, 10, 25, .25);
      box-shadow: 0 20px 80px rgba(0, 0, 0, .35);
      backdrop-filter: blur(8px);
    }

    h1 {
      margin: 0 0 6px 0;
      font-size: 44px
    }

    .sub {
      margin: 0 0 18px 0;
      color: var(--muted);
      font-size: 14px
    }

    .topRow {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap
    }

    .pill {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid var(--line);
      color: var(--muted);
      font-size: 13px;
      background: rgba(255, 255, 255, .04);
      max-width: 100%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    /* KPI */
    .kpiWrap {
      margin-top: 14px;
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 14px;
      background: rgba(255, 255, 255, .03);
    }

    .kpiGrid {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 10px;
    }

    .kpiCard {
      border: 1px solid rgba(255, 255, 255, .10);
      border-radius: 14px;
      padding: 12px 12px;
      background: rgba(0, 0, 0, .12);
      min-height: 86px;
      overflow: hidden;
    }

    .kpiTitle {
      color: rgba(233, 238, 252, .72);
      font-size: 12px;
      font-weight: 900;
      letter-spacing: .2px
    }

    .kpiValue {
      font-size: 28px;
      font-weight: 950;
      margin-top: 4px;
      line-height: 1.05
    }

    .kpiSub {
      color: rgba(233, 238, 252, .62);
      font-size: 12px;
      margin-top: 6px
    }

    .bar {
      margin-top: 10px;
      height: 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, .08);
      overflow: hidden;
    }

    .bar>div {
      height: 100%;
      width: 0%;
    }

    .barGrad {
      background: linear-gradient(90deg, #ff5a5a, #f0c85b, #57d47a);
    }

    .kpiActions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      align-items: center;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    /* Uploader */
    .uploader {
      margin-top: 14px;
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 14px;
      background: rgba(255, 255, 255, .03);
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
    }

    .drop {
      flex: 1;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, .10);
      padding: 14px 14px;
      background: rgba(0, 0, 0, .12);
      color: var(--muted);
      user-select: none;
    }

    .drop.drag {
      outline: 2px solid rgba(240, 200, 91, .55);
      color: var(--text);
    }

    .btn {
      border: 0;
      padding: 12px 18px;
      border-radius: 12px;
      background: linear-gradient(180deg, var(--gold), var(--gold2));
      color: #1a1406;
      font-weight: 950;
      cursor: pointer;
      box-shadow: 0 10px 26px rgba(240, 200, 91, .20);
      white-space: nowrap;
    }

    .btnSmall {
      border: 0;
      padding: 9px 14px;
      border-radius: 12px;
      background: linear-gradient(180deg, var(--gold), var(--gold2));
      color: #1a1406;
      font-weight: 950;
      cursor: pointer;
      white-space: nowrap;
    }

    .btnGhost {
      border: 1px solid rgba(255, 255, 255, .14);
      padding: 10px 14px;
      border-radius: 12px;
      background: rgba(255, 255, 255, .06);
      color: var(--text);
      font-weight: 900;
      cursor: pointer;
      white-space: nowrap;
    }

    .btnGhost:disabled {
      opacity: .45;
      cursor: not-allowed;
    }

    input[type="file"] {
      display: none
    }

    .msg {
      margin: 10px 0 10px 0;
      font-weight: 900
    }

    .msg.ok {
      color: var(--green)
    }

    .msg.err {
      color: var(--red)
    }

    .searchWrap {
      position: relative;
      margin: 10px 0 8px 0;
      width: 100%;
    }

    .search {
      width: 100%;
      padding: 12px 14px;
      padding-right: 40px;
      /* space for X */
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, .12);
      background: #f7f8fb;
      color: #141414;
      outline: none;
      font-size: 14px;
      margin: 0;
      /* reset */
    }

    .clearBtn {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0, 0, 0, .1);
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      color: #555;
      font-weight: bold;
      display: none;
      /* hidden by default */
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .clearBtn:hover {
      background: rgba(0, 0, 0, .2)
    }

    .clearBtn.show {
      display: flex
    }

    .miniRow {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      margin: 6px 0 12px 0;
      flex-wrap: wrap;
    }

    .miniHint {
      color: rgba(233, 238, 252, .62);
      font-size: 12px
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, .12);
      background: rgba(255, 255, 255, .05);
      color: rgba(233, 238, 252, .78);
      font-size: 12px;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .dot.green {
      background: var(--green)
    }

    .dot.gold {
      background: var(--gold)
    }

    .dot.red {
      background: var(--red)
    }

    .tableWrap {
      width: 100%;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 12px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      min-width: 780px
    }

    th,
    td {
      padding: 12px 8px;
      border-bottom: 1px solid rgba(255, 255, 255, .10);
      text-align: left
    }

    th {
      color: rgba(233, 238, 252, .65);
      font-weight: 900;
      font-size: 12px
    }

    .muted {
      color: var(--muted)
    }

    .right {
      text-align: right
    }

    .foot {
      margin-top: 10px;
      color: rgba(233, 238, 252, .60);
      font-size: 12px
    }

    .statusPill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, .14);
      background: rgba(255, 255, 255, .05);
      font-weight: 900;
      font-size: 12px;
      user-select: none;
      white-space: nowrap;
    }

    .statusPill.clickable {
      cursor: pointer;
    }

    .statusPill .sDot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .sGreen {
      background: var(--green)
    }

    .sGold {
      background: var(--gold)
    }

    .sRed {
      background: var(--red)
    }

    .statusHint {
      margin-top: 6px;
      font-size: 11px;
      color: rgba(233, 238, 252, .55)
    }

    /* Modales */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .55);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 999;
    }

    .overlay.show {
      display: flex
    }

    .modal {
      width: min(520px, 100%);
      background: rgba(7, 16, 39, .96);
      border: 1px solid rgba(255, 255, 255, .12);
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 25px 90px rgba(0, 0, 0, .55);
    }

    .modal h3 {
      margin: 0 0 8px 0;
      font-size: 18px
    }

    .modal .desc {
      color: rgba(233, 238, 252, .70);
      font-size: 13px;
      line-height: 1.35
    }

    .modal label {
      display: block;
      font-size: 13px;
      color: var(--muted);
      margin: 12px 0 6px
    }

    .modal input {
      width: 100%;
      padding: 12px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, .12);
      background: #f7f8fb;
      color: #141414;
      outline: none;
      font-size: 16px;
    }

    .modal .row {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 14px;
      flex-wrap: wrap
    }

    .btn2 {
      border: 1px solid rgba(255, 255, 255, .14);
      padding: 10px 14px;
      border-radius: 12px;
      background: rgba(255, 255, 255, .06);
      color: var(--text);
      font-weight: 900;
      cursor: pointer;
    }

    .btn3 {
      border: 0;
      padding: 10px 14px;
      border-radius: 12px;
      background: linear-gradient(180deg, var(--gold), var(--gold2));
      color: #1a1406;
      font-weight: 950;
      cursor: pointer;
    }

    @media (max-width: 980px) {
      .kpiGrid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }

      table {
        min-width: 740px
      }
    }

    @media (max-width: 760px) {
      body {
        padding: 18px 12px;
        padding-top: calc(18px + env(safe-area-inset-top));
        padding-bottom: calc(18px + env(safe-area-inset-bottom));
      }

      .frame {
        padding: 16px
      }

      h1 {
        font-size: 30px
      }

      .uploader {
        flex-direction: column;
        align-items: stretch
      }

      .btn,
      .btnGhost {
        width: 100%
      }

      .kpiGrid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      table {
        min-width: 720px
      }
    }
  </style>
</head>

<body>
  <div class="frame">
    <div class="topRow">
      <div>
        <h1>Cobranza AVYNA - Beluga</h1>
        <p class="sub">Arrastra y suelta el PDF. El sistema extrae <b>cliente + total</b> automáticamente.</p>
      </div>
      <div class="pill" id="batchPill">Batch actual: —</div>
    </div>

    <!-- KPIs -->
    <div class="kpiWrap">
      <div class="kpiGrid">
        <div class="kpiCard">
          <div class="kpiTitle">% Cobranza</div>
          <div class="kpiValue" id="kpiPct">—</div>
          <div class="kpiSub" id="kpiPctSub">—</div>
          <div class="bar">
            <div id="kpiBar" class="barGrad"></div>
          </div>
        </div>

        <div class="kpiCard">
          <div class="kpiTitle">Cobrado</div>
          <div class="kpiValue" id="kpiCobrado">—</div>
          <div class="kpiSub">Pagos acumulados (solo entregadas)</div>
        </div>

        <div class="kpiCard">
          <div class="kpiTitle">Por cobrar</div>
          <div class="kpiValue" id="kpiPorCobrar">—</div>
          <div class="kpiSub">Saldo total (solo entregadas)</div>
        </div>

        <div class="kpiCard">
          <div class="kpiTitle">Utilidad cobrada</div>
          <div class="kpiValue" id="kpiUtilCobrada">—</div>
          <div class="kpiSub">Tu margen ya cobrado</div>
        </div>

        <div class="kpiCard">
          <div class="kpiTitle">Utilidad por cobrar</div>
          <div class="kpiValue" id="kpiUtilPorCobrar">—</div>
          <div class="kpiSub">Tu margen pendiente</div>
        </div>
      </div>

      <div class="kpiActions">
        <button class="btnGhost" id="whoBtn" type="button">Ver quién falta</button>
        <button class="btnGhost" id="backBatchBtn" type="button">Volver a batch</button>
        <button class="btnGhost" id="reportBtn" type="button" disabled>Reporte mensual</button>
      </div>
    </div>

    <!-- Uploader -->
    <div class="uploader">
      <div id="dropZone" class="drop">Arrastra aquí el PDF</div>
      <button id="pickBtn" class="btn" type="button">Seleccionar PDF</button>
      <input id="fileInput" type="file" accept="application/pdf" />
    </div>

    <div id="msg" class="msg"></div>

    <div class="searchWrap">
      <input id="search" class="search" placeholder="Buscar cliente o nota (histórico)..." />
      <button id="clearSearch" class="clearBtn" title="Borrar búsqueda">✕</button>
    </div>

    <div class="miniRow">
      <div class="miniHint" id="modeHint">—</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;">
        <div class="tag"><span class="dot gold"></span>Lista (batch): <b id="countBatch">0</b></div>
        <div class="tag"><span class="dot green"></span>Histórico: <b id="countAll">0</b></div>
        <div class="tag"><span class="dot red"></span>Pendientes: <b id="countPend">0</b></div>
      </div>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th style="width:38%">Cliente</th>
            <th class="right">Total</th>
            <th class="right">Pagado</th>
            <th class="right">Saldo</th>
            <th>Estado</th>
            <th>Acción</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr>
            <td class="muted" colspan="6">Sin notas todavía.</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="foot">Por defecto ves el <b>batch actual</b>. Con búsqueda ves <b>histórico</b>. “Ver quién falta”
      muestra <b>pendientes globales</b> (entregadas con saldo).</div>
  </div>

  <!-- Modal: Pago -->
  <div id="overlayPay" class="overlay" role="dialog" aria-modal="true">
    <div class="modal">
      <h3>Registrar pago</h3>
      <div class="muted" id="payClient" style="margin-top:-2px"></div>

      <label>Monto pagado</label>
      <input id="payAmount" inputmode="decimal" placeholder="Ej. 500" />

      <div class="row">
        <button id="cancelPay" class="btn2" type="button">Cancelar</button>
        <button id="savePay" class="btn3" type="button">Guardar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Entregado -->
  <div id="overlayEnt" class="overlay" role="dialog" aria-modal="true">
    <div class="modal">
      <h3>Marcar como entregado</h3>
      <div class="desc" id="entDesc"></div>

      <div class="row">
        <button id="cancelEnt" class="btn2" type="button">Cancelar</button>
        <button id="saveEnt" class="btn3" type="button">Sí, entregado</button>
      </div>
    </div>
  </div>

  <!-- PDF Libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

  <script>
    // Elements
    const dropZone = document.getElementById("dropZone");
    const pickBtn = document.getElementById("pickBtn");
    const fileInput = document.getElementById("fileInput");
    const msg = document.getElementById("msg");
    const tbody = document.getElementById("tbody");
    const batchPill = document.getElementById("batchPill");
    const search = document.getElementById("search");
    const clearSearch = document.getElementById("clearSearch");
    const modeHint = document.getElementById("modeHint");
    const countBatch = document.getElementById("countBatch");
    const countAll = document.getElementById("countAll");
    const countPend = document.getElementById("countPend");

    // KPI
    const kpiPct = document.getElementById("kpiPct");
    const kpiPctSub = document.getElementById("kpiPctSub");
    const kpiCobrado = document.getElementById("kpiCobrado");
    const kpiPorCobrar = document.getElementById("kpiPorCobrar");
    const kpiUtilCobrada = document.getElementById("kpiUtilCobrada");
    const kpiUtilPorCobrar = document.getElementById("kpiUtilPorCobrar");
    const kpiBar = document.getElementById("kpiBar");

    // Actions
    const whoBtn = document.getElementById("whoBtn");
    const backBatchBtn = document.getElementById("backBatchBtn");
    const reportBtn = document.getElementById("reportBtn");

    // Modal Pago
    const overlayPay = document.getElementById("overlayPay");
    const payClient = document.getElementById("payClient");
    const payAmount = document.getElementById("payAmount");
    const cancelPay = document.getElementById("cancelPay");
    const savePay = document.getElementById("savePay");
    let payingId = null;

    // Modal Entregado
    const overlayEnt = document.getElementById("overlayEnt");
    const entDesc = document.getElementById("entDesc");
    const cancelEnt = document.getElementById("cancelEnt");
    const saveEnt = document.getElementById("saveEnt");
    let deliveringId = null;

    // State
    window.__allNotas = [];
    window.__batchKey = null;
    window.__viewMode = "batch"; // "batch" | "pendientes"

    function setMsg(type, text) {
      msg.className = "msg " + (type || "");
      msg.textContent = text || "";
    }

    function money(n) {
      if (n == null || Number.isNaN(n)) return "—";
      const rounded = Math.round(n);
      return "$" + rounded.toLocaleString("es-MX");
    }

    function escapeHtml(s) {
      return String(s || "").replace(/[&<>"']/g, m => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;"
      }[m]));
    }

    // --- Closing Control Logic ---
    // Rule: Button visible 6h after click OR strictly controlled by server?
    // Requirement says: "remains visible for 6 hours after the *first click*."
    // And "patient button" appears at end of month.
    function checkClosingStatus() {
      const remaining = daysToEndOfMonth(new Date());
      // Logic: If month ended (remaining=0), show button.
      // PLUS: LocalStorage check for 'patient' timer? 
      // Better: Just enable it if remaining=0. The *timer* is for "Active Closing".

      const now = Date.now();
      const lastClose = localStorage.getItem("beluga_close_start");
      const SIX_HOURS = 6 * 60 * 60 * 1000;

      if (lastClose && (now - Number(lastClose) < SIX_HOURS)) {
        // Active closing session!
        let timeLeft = Math.ceil((SIX_HOURS - (now - Number(lastClose))) / (60 * 1000));
        reportBtn.disabled = false;
        reportBtn.textContent = `Modo Cierre Activo (${Math.floor(timeLeft / 60)}h ${timeLeft % 60}m)`;
        reportBtn.style.background = "linear-gradient(90deg, #ff5a5a, #f0c85b)";
        reportBtn.style.color = "#000";
        reportBtn.style.border = "none";
        return;
      }

      if (remaining === 0) {
        reportBtn.disabled = false;
        reportBtn.textContent = "Reporte mensual (Iniciar Cierre)";
        reportBtn.style.background = ""; // Reset
        reportBtn.style.color = "";
        reportBtn.style.border = "";
      } else {
        reportBtn.disabled = true;
        reportBtn.textContent = `Cierre en ${remaining} día${remaining === 1 ? "" : "s"}`;
        reportBtn.style.background = "";
        reportBtn.style.color = "";
        reportBtn.style.border = "";
      }
    }

    function daysToEndOfMonth(d = new Date()) {
      const end = new Date(d.getFullYear(), d.getMonth() + 1, 0);
      end.setHours(0, 0, 0, 0);
      const cur = new Date(d);
      cur.setHours(0, 0, 0, 0);
      const diffMs = end.getTime() - cur.getTime();
      return Math.max(0, Math.round(diffMs / (24 * 60 * 60 * 1000)));
    }

    // --- PDF Generator ---
    async function generateReport() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Logo Avyna (Draw simplified text if image fails, or try loading from DOM)
      // Ideally convert /apple-touch-icon.png to base64, but that's heavy.
      // Let's use a nice text header + "Beluga" System

      // Header
      doc.setFillColor(7, 16, 39); // Deep Blue
      doc.rect(0, 0, 210, 40, 'F');

      doc.setTextColor(255, 255, 255);
      doc.setFontSize(22);
      doc.setFont("helvetica", "bold");
      doc.text("AVYNA", 14, 20);
      doc.setFontSize(12);
      doc.setFont("helvetica", "normal");
      doc.text("Reporte de Cobranza (Beluga)", 14, 28);

      // Date
      doc.setFontSize(10);
      doc.text(new Date().toLocaleDateString("es-MX", { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }), 196, 20, { align: 'right' });

      // Calculate totals
      const notas = window.__allNotas; // Use ALL history or just current batch? "Reporte Mensual" implies current month context usually, but Beluga is batch-based.
      // Let's report on "Entregadas" (Real debt)
      const entregadas = notas.filter(n => n.deliveredAt);

      let totalCobrable = 0;
      let totalCobrado = 0;

      // Table Rows
      const rows = entregadas.map(n => {
        const total = typeof n.total === 'number' ? n.total : 0;
        let pagado = 0;
        // Client-side Calc of pagado from arrays if needed, but API usually delivers calculated field
        // Wait, server delivers 'pagos: [...]' and MIGHT deliver 'pagado' if computed?
        // Let's check API response... API sends `...computeCredito`, which sends `saldo`.
        // Pagado = Total - Saldo.
        if (typeof n.saldo === 'number') {
          pagado = total - n.saldo;
        }

        totalCobrable += total;
        totalCobrado += pagado;

        return [
          n.cliente || "Sin cliente",
          new Date(n.deliveredAt).toLocaleDateString("es-MX"),
          "$" + Math.round(total).toLocaleString(),
          "$" + Math.round(pagado).toLocaleString(),
          "$" + Math.round(n.saldo).toLocaleString(),
          n.statusCredito
        ];
      });

      // KPIs Section
      let y = 50;
      doc.setTextColor(0, 0, 0);
      doc.setFontSize(14);
      doc.text("Resumen Ejecutivo", 14, y);
      y += 8;

      doc.setFontSize(10);
      doc.text(`Total Cobrable: $${Math.round(totalCobrable).toLocaleString()}`, 14, y);
      doc.text(`Total Cobrado: $${Math.round(totalCobrado).toLocaleString()}`, 80, y);
      doc.text(`Saldo Pendiente: $${Math.round(totalCobrable - totalCobrado).toLocaleString()}`, 150, y);
      y += 10;
      const pct = totalCobrable > 0 ? (totalCobrado / totalCobrable * 100).toFixed(1) : 0;
      doc.text(`Eficiencia de Cobranza: ${pct}%`, 14, y);


      // VIP / Socios Estratégicos
      y += 20;
      doc.setFontSize(14);
      doc.setTextColor(240, 200, 91); // Gold-ish
      doc.text("⭐ Socios Estratégicos (VIP)", 14, y);
      doc.setTextColor(0, 0, 0);
      y += 8;

      // Find VIPs
      // We need to know who is VIP. The API notes have `isVip: true`.
      const vips = [...new Set(window.__allNotas.filter(n => n.isVip).map(n => n.cliente))];

      doc.setFontSize(10);
      if (vips.length > 0) {
        doc.text(vips.join(", "), 14, y, { maxWidth: 180 });
        y += (Math.ceil(doc.getTextWidth(vips.join(", ")) / 180) * 6) + 10;
      } else {
        doc.text("Ningún cliente califica como VIP este periodo.", 14, y);
        y += 10;
      }

      // Detalle Table
      y += 10;
      doc.setFontSize(14);
      doc.text("Detalle de Notas Entregadas", 14, y);
      y += 4;

      doc.autoTable({
        startY: y,
        head: [['Cliente', 'Fecha', 'Total', 'Pagado', 'Saldo', 'Estatus']],
        body: rows,
        theme: 'grid',
        headStyles: { fillColor: [7, 16, 39] },
        styles: { fontSize: 8 },
      });

      doc.save("Reporte_Avyna_Beluga.pdf");

      // Trigger "Active Closing" logic
      if (!localStorage.getItem("beluga_close_start")) {
        localStorage.setItem("beluga_close_start", Date.now());
        checkClosingStatus();
      }
    }

    reportBtn.onclick = generateReport;


    function statusLabel(n) {
      const s = (n.statusCredito || "").toUpperCase();
      if (s === "LIQUIDADO") return { text: "Liquidado", dot: "sGreen", clickable: false };
      if (s === "VENCIDO") return { text: "Vencido", dot: "sRed", clickable: false };
      if (s === "POR_VENCER") return { text: "Por vencer", dot: "sGold", clickable: false };
      if (s === "EN_PLAZO") return { text: "En plazo", dot: "sGreen", clickable: false };
      return { text: "Pre-entrega", dot: "sGold", clickable: true };
    }

    function render(list) {
      if (!list || !list.length) {
        tbody.innerHTML = `<tr><td class="muted" colspan="6">Sin notas para mostrar.</td></tr>`;
        return;
      }

      tbody.innerHTML = list.map(n => {
        const clientName = escapeHtml(n.cliente || n.originalName || n.filename || "—");

        // VIP STAR Logic
        const vipTag = n.isVip ? '<span title="Socio Estratégico VIP" style="color: #f0c85b; margin-right:4px;">⭐</span>' : '';
        const clientDisplay = vipTag + clientName;

        const total = money(n.total);
        const pagado = money(typeof n.pagado === 'number' ? n.pagado : (n.total - n.saldo)); // Infer if needed
        const saldo = money(n.saldo);

        const st = statusLabel(n);
        const due = n.dueAt ? new Date(n.dueAt).toLocaleDateString("es-MX") : null;

        const statusHtml = `
          <div>
            <div class="statusPill ${st.clickable ? "clickable" : ""}" data-ent="${st.clickable ? n.id : ""}">
              <span class="sDot ${st.dot}"></span>
              ${escapeHtml(st.text)}
            </div>
            ${due ? `<div class="statusHint">Vence: ${escapeHtml(due)}</div>` : (st.clickable ? `<div class="statusHint">Click para marcar entregado</div>` : ``)}
          </div>
        `;

        // Action Button
        let actionHtml = ``;
        if (n.saldo > 0 && n.deliveredAt) {
          actionHtml = `<button class="btnSmall" data-pay="${n.id}" data-client="${escapeHtml(n.cliente)}">Registrar Pago</button>`;
        }

        return `
          <tr>
            <td style="font-weight:600; color:#e9eefc;">${clientDisplay}</td>
            <td class="right">${total}</td>
            <td class="right muted">${pagado}</td>
            <td class="right" style="color:${n.saldo > 0 ? 'var(--red)' : 'var(--green)'}">${saldo}</td>
            <td>${statusHtml}</td>
            <td>${actionHtml}</td>
          </tr>
        `;
      }).join("");

      // Re-attach listeners is handled by delegation usually, but here likely inline or global
      // See below for event delegation
    }

    // --- Data Load ---
    async function loadData() {
      try {
        const res = await fetch("/api/notas");
        const data = await res.json();

        window.__batchKey = data.batchKey;
        window.__allNotas = data.notas || [];

        updateKPIs();
        updateUI();

        // Update batch pill
        batchPill.textContent = `Batch actual: ${data.batchKey || "..."}`;

        checkClosingStatus(); // Check timer

      } catch (e) {
        console.error(e);
        setMsg("err", "Error cargando notas");
      }
    }

    // ... [Original listeners for drag/drop remain the same, need to be careful not to delete them]
    // I should create a separate block or include them? 
    // The instructions said "The code has been modified to include a line number".
    // I am replacing the <script> block. The previous ViewFile allowed me to see most logic.
    // I need to be careful about what I replaced. 
    // I replaced from line 683 (Start of Script) to end.
    // I need to include the rest of the file logic!

    // Event Delegation for Table Buttons
    tbody.addEventListener("click", e => {
      const btn = e.target.closest("button");
      const pill = e.target.closest(".statusPill");

      if (btn && btn.dataset.pay) {
        openPayModal(btn.dataset.pay, btn.dataset.client);
      }

      if (pill && pill.classList.contains("clickable") && pill.dataset.ent) {
        openEntModal(pill.dataset.ent);
      }
    });

    // ... [Including rest of logic derived from context or rewritten]

    function updateKPIs() {
      // Calculate based on allNotas
      const entregadas = window.__allNotas.filter(n => !!n.deliveredAt);

      let totalCobrable = 0;
      let totalCobrado = 0;

      for (const n of entregadas) {
        const total = typeof n.total === "number" && Number.isFinite(n.total) ? n.total : 0;
        // Pagado logic:
        let p = 0;
        if (Array.isArray(n.pagos)) p = n.pagos.reduce((a, x) => a + (Number(x.monto) || 0), 0);
        else p = typeof n.pagado === 'number' ? n.pagado : 0;

        totalCobrable += total;
        totalCobrado += Math.min(p, total);
      }

      const totalSaldo = Math.max(totalCobrable - totalCobrado, 0);
      const pct = totalCobrable > 0 ? totalCobrado / totalCobrable : 0;

      kpiPct.textContent = (pct * 100).toFixed(1) + "%";
      kpiPctSub.textContent = "Eficiencia Global"; // Updated label

      kpiCobrado.textContent = money(totalCobrado);
      kpiPorCobrar.textContent = money(totalSaldo);

      kpiUtilCobrada.textContent = money(totalCobrado * 0.4);
      kpiUtilPorCobrar.textContent = money(totalSaldo * 0.4);

      // Bar
      const pctClamped = Math.min(Math.max(pct * 100, 0), 100);
      document.querySelector("#kpiBar").style.background = `conic-gradient(var(--green) ${pctClamped}%, transparent 0)`; // Wait, original was a bar width
      // Original: <div id="kpiBar" class="barGrad"></div> inside .bar -> div width
      // Correcting:
      kpiBar.style.width = pctClamped + "%";
    }

    function updateUI() {
      // Counts
      const all = window.__allNotas;
      const batch = all.filter(n => n.batchKey === window.__batchKey);
      const pend = all.filter(n => n.deliveredAt && n.saldo > 0);

      countAll.textContent = all.length;
      countBatch.textContent = batch.length;
      countPend.textContent = pend.length;

      let list = [];
      if (window.__viewMode === "batch") list = batch;
      if (window.__viewMode === "pendientes") list = pend;

      // Filter by search
      const q = search.value.toLowerCase().trim();
      if (q) {
        list = all.filter(n => {
          const s = (n.cliente || "").toLowerCase() + " " + (n.filename || "").toLowerCase();
          return s.includes(q);
        });
        clearSearch.classList.add("show");
        modeHint.textContent = `Resultados: ${list.length}`;
      } else {
        clearSearch.classList.remove("show");
        modeHint.textContent = window.__viewMode === "batch" ? "Vista: Batch Actual" : "Vista: Pendientes Globales";
      }

      render(list);
    }

    // Interaction Listeners
    search.addEventListener("input", updateUI);
    clearSearch.addEventListener("click", () => {
      search.value = "";
      updateUI();
    });

    whoBtn.addEventListener("click", () => {
      window.__viewMode = "pendientes";
      search.value = "";
      updateUI();
    });

    backBatchBtn.addEventListener("click", () => {
      window.__viewMode = "batch";
      search.value = "";
      updateUI();
    });

    // Modal Pay
    function openPayModal(id, client) {
      payingId = id;
      payClient.textContent = client;
      payAmount.value = "";
      overlayPay.classList.add("show");
      payAmount.focus();
    }

    cancelPay.addEventListener("click", () => {
      overlayPay.classList.remove("show");
      payingId = null;
    });

    savePay.addEventListener("click", async () => {
      const val = parseFloat(payAmount.value);
      if (!payingId || isNaN(val) || val <= 0) return;

      try {
        const res = await fetch("/api/pago", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id: payingId, monto: val })
        });
        const json = await res.json();
        if (json.ok) {
          loadData(); // Reload all
          overlayPay.classList.remove("show");
          setMsg("ok", "Pago registrado");
        } else {
          alert(json.message);
        }
      } catch (e) {
        alert("Error de red");
      }
    });

    // Modal Ent
    function openEntModal(id) {
      deliveringId = id;
      entDesc.textContent = "¿Confirmar entrega y activar crédito (15 días)?";
      overlayEnt.classList.add("show");
    }

    cancelEnt.addEventListener("click", () => {
      overlayEnt.classList.remove("show");
      deliveringId = null;
    });

    saveEnt.addEventListener("click", async () => {
      if (!deliveringId) return;
      try {
        const res = await fetch("/api/entregar", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id: deliveringId })
        });
        const json = await res.json();
        if (json.ok) {
          loadData();
          overlayEnt.classList.remove("show");
        } else {
          alert(json.message);
        }
      } catch (e) { alert("Error"); }
    });

    // Uploader
    pickBtn.addEventListener("click", () => fileInput.click());
    fileInput.addEventListener("change", () => handleFiles(fileInput.files));

    dropZone.addEventListener("dragover", e => {
      e.preventDefault();
      dropZone.classList.add("drag");
    });
    dropZone.addEventListener("dragleave", () => dropZone.classList.remove("drag"));
    dropZone.addEventListener("drop", e => {
      e.preventDefault();
      dropZone.classList.remove("drag");
      handleFiles(e.dataTransfer.files);
    });

    async function handleFiles(files) {
      if (!files || !files.length) return;
      const f = files[0];
      if (f.type !== "application/pdf") return alert("Solo PDF");

      setMsg("", "Subiendo...");
      const formData = new FormData();
      formData.append("pdf", f);

      try {
        const res = await fetch("/api/upload", {
          method: "POST",
          body: formData
        });
        const json = await res.json();
        if (json.ok) {
          if (json.replaced) setMsg("ok", "Nota actualizada (re-subida)");
          else setMsg("ok", "Nota creada con éxito");
          loadData();
        } else {
          setMsg("err", json.message || "Error al subir");
        }
      } catch (e) {
        setMsg("err", "Error de red");
      }
    }

    // Init
    loadData();
    setInterval(loadData, 30000); // Poll every 30s
    checkClosingStatus(); // Init check
  </script>
</body>

</html>
window.__viewMode = "pendientes";
applyFilter();
});
backBatchBtn.addEventListener("click", () => {
window.__viewMode = "batch";
applyFilter();
});

// Search
// Search
function toggleClearBtn() {
if (search.value && search.value.trim().length > 0) clearSearch.classList.add("show");
else clearSearch.classList.remove("show");
}

search.addEventListener("input", () => {
applyFilter();
toggleClearBtn();
});

clearSearch.addEventListener("click", () => {
search.value = "";
applyFilter();
toggleClearBtn();
search.focus();
});

// Drag & drop
["dragenter", "dragover"].forEach(ev => {
dropZone.addEventListener(ev, (e) => {
e.preventDefault();
e.stopPropagation();
dropZone.classList.add("drag");
});
});
["dragleave", "drop"].forEach(ev => {
dropZone.addEventListener(ev, (e) => {
e.preventDefault();
e.stopPropagation();
dropZone.classList.remove("drag");
});
});
dropZone.addEventListener("drop", (e) => {
const f = e.dataTransfer.files && e.dataTransfer.files[0];
if (!f) return;
uploadFile(f);
});

// Picker
pickBtn.addEventListener("click", () => fileInput.click());
fileInput.addEventListener("change", () => {
const f = fileInput.files && fileInput.files[0];
if (!f) return;
uploadFile(f);
fileInput.value = "";
});

// Report button (solo UI por ahora)
reportBtn.addEventListener("click", () => {
if (reportBtn.disabled) return;
setMsg("ok", "Reporte mensual: listo para generar (fin de mes).");
});

// REFRESH “REAL” EN iPHONE:
// - al volver a la app (focus/visibility)
// - polling suave cuando está visible
function isVisible() {
return document.visibilityState === "visible";
}

document.addEventListener("visibilitychange", () => {
if (isVisible()) refreshList();
});
window.addEventListener("focus", () => refreshList());

setInterval(() => {
if (isVisible()) refreshList();
}, 15000);

// Init
updateReportButton();
refreshList();
</script>
</body>

</html>